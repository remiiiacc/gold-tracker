<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central Bank Gold Reserves Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        :root {
            --gold-primary: #D4AF37;
            --gold-light: #F4E4BA;
            --gold-dark: #996515;
            --bg-dark: #0D0D0D;
            --bg-card: #1A1A1A;
            --bg-card-hover: #242424;
            --text-primary: #FAFAFA;
            --text-secondary: #A0A0A0;
            --text-muted: #666666;
            --border-color: #2A2A2A;
            --positive: #22C55E;
            --negative: #EF4444;
            --accent-blue: #3B82F6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--bg-card) 0%, #1F1F1F 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 24px 48px;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo { display: flex; align-items: center; gap: 16px; }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
        }

        .logo-text h1 { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
        .logo-text span { font-size: 12px; color: var(--text-secondary); font-family: 'Space Mono', monospace; }

        .header-actions { display: flex; gap: 12px; align-items: center; }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.4);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--gold-primary);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            font-family: 'Space Mono', monospace;
            background: rgba(34, 197, 94, 0.2);
            color: var(--positive);
            border: 1px solid var(--positive);
        }

        .main { max-width: 1600px; margin: 0 auto; padding: 32px 48px; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--gold-primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-family: 'Space Mono', monospace;
        }

        .stat-value { font-size: 32px; font-weight: 700; color: var(--gold-primary); margin-bottom: 4px; }
        .stat-change { font-size: 14px; display: flex; align-items: center; gap: 4px; }
        .stat-change.positive { color: var(--positive); }
        .stat-change.negative { color: var(--negative); }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 16px;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .tab:hover { color: var(--text-primary); background: var(--bg-card); }
        .tab.active { background: var(--bg-card); color: var(--gold-primary); border-color: var(--gold-primary); }

        .content-section { display: none; }
        .content-section.active { display: block; }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .chart-title { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .chart-subtitle { font-size: 13px; color: var(--text-secondary); }
        .chart-container { height: 300px; position: relative; }

        .time-filters { display: flex; gap: 8px; }

        .time-filter {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            font-family: 'Space Mono', monospace;
            transition: all 0.2s ease;
        }

        .time-filter:hover { border-color: var(--gold-primary); color: var(--text-primary); }
        .time-filter.active { background: var(--gold-primary); border-color: var(--gold-primary); color: #000; }

        .historical-controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .control-group { display: flex; flex-direction: column; gap: 6px; }

        .control-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Space Mono', monospace;
        }

        .control-group select {
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            min-width: 200px;
        }

        .control-group select:hover { border-color: var(--gold-primary); }
        .control-group select:focus { outline: none; border-color: var(--gold-primary); }

        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-title { font-size: 16px; font-weight: 600; }

        .search-box {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .search-box input {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            outline: none;
            width: 200px;
        }

        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px 16px; border-bottom: 1px solid var(--border-color); }

        th {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Space Mono', monospace;
            font-weight: 500;
        }

        td { font-size: 14px; }
        tr:hover { background: var(--bg-card-hover); }

        .country-cell { display: flex; align-items: center; gap: 12px; }

        .country-flag {
            width: 32px;
            height: 24px;
            background: var(--bg-dark);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--text-secondary);
            font-family: 'Space Mono', monospace;
        }

        .change-positive { color: var(--positive); }
        .change-negative { color: var(--negative); }
        .tonnes { font-family: 'Space Mono', monospace; }

        .pct-change {
            font-family: 'Space Mono', monospace;
            font-size: 12px;
        }

        .sources-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .source-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .source-card:hover { border-color: var(--gold-primary); }

        .source-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-dark);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
        }

        .source-name { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
        .source-desc { font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.5; }
        .source-meta { display: flex; gap: 16px; font-size: 12px; color: var(--text-muted); margin-bottom: 16px; }
        .source-link { color: var(--gold-primary); text-decoration: none; font-size: 14px; font-weight: 500; }
        .source-link:hover { text-decoration: underline; }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-color: var(--positive); }
        .toast.error { border-color: var(--negative); }

        /* Scrollable table wrapper */
        .table-scroll-wrapper {
            overflow-x: auto;
        }

        @media (max-width: 1200px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-grid { grid-template-columns: 1fr; }
            .sources-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .header { padding: 16px 24px; }
            .main { padding: 24px; }
            .stats-grid { grid-template-columns: 1fr; }
            .sources-grid { grid-template-columns: 1fr; }
            .header-content { flex-direction: column; gap: 16px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üè¶</div>
                <div class="logo-text">
                    <h1>Central Bank Gold Tracker</h1>
                    <span>QUARTERLY RESERVES MONITORING</span>
                </div>
            </div>
            <div class="header-actions">
                <span class="status-badge">Q3 2025 DATA</span>
                <button class="btn btn-secondary" onclick="refreshData()">‚Üª Refresh</button>
                <button class="btn btn-primary" onclick="exportData()">‚Üì Export CSV</button>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Global CB Holdings</div>
                <div class="stat-value">36,359t</div>
                <div class="stat-change positive"><span>‚ñ≤</span> +220t Q3 2025</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">YTD Net Purchases</div>
                <div class="stat-value">634t</div>
                <div class="stat-change positive"><span>‚ñ≤</span> Q1-Q3 2025</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Top Q3 Buyer</div>
                <div class="stat-value">Poland</div>
                <div class="stat-change positive"><span>‚ñ≤</span> +67t YTD</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Last Updated</div>
                <div class="stat-value" id="lastUpdated" style="font-size: 24px;">‚Äî</div>
                <div class="stat-change"><span>WGC Q3 2025 Report</span></div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="overview">Overview</button>
            <button class="tab" data-tab="historical">Historical (Quarterly)</button>
            <button class="tab" data-tab="countries">By Country</button>
            <button class="tab" data-tab="sources">Data Sources</button>
        </div>

        <!-- Overview Section -->
        <section class="content-section active" id="overview">
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Quarterly Central Bank Net Purchases</div>
                            <div class="chart-subtitle">Tonnes per quarter (Source: World Gold Council)</div>
                        </div>
                        <div class="time-filters">
                            <button class="time-filter" data-quarters="8">2Y</button>
                            <button class="time-filter active" data-quarters="12">3Y</button>
                            <button class="time-filter" data-quarters="20">5Y</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="quarterlyPurchasesChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Top Buyers (Q3 2025)</div>
                            <div class="chart-subtitle">Net purchases in tonnes</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="topBuyersChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Cumulative Central Bank Holdings</div>
                        <div class="chart-subtitle">Total tonnes held by central banks globally (quarterly)</div>
                    </div>
                </div>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="cumulativeChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Historical Section -->
        <section class="content-section" id="historical">
            <div class="historical-controls">
                <div class="control-group">
                    <label class="control-label">Time Period</label>
                    <select id="historicalPeriod" onchange="updateHistoricalChart()">
                        <option value="8">Last 2 Years (8Q)</option>
                        <option value="12" selected>Last 3 Years (12Q)</option>
                        <option value="20">Last 5 Years (20Q)</option>
                        <option value="40">Last 10 Years (40Q)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label">View</label>
                    <select id="historicalView" onchange="updateHistoricalChart()">
                        <option value="quarterly">Quarterly Net Purchases</option>
                        <option value="cumulative">Cumulative Holdings</option>
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label">Country</label>
                    <select id="countryFilter" onchange="updateHistoricalChart()">
                        <option value="all">All Central Banks (Global)</option>
                        <optgroup label="Top Net Buyers (2022-2025)">
                            <option value="PL">üáµüá± Poland</option>
                            <option value="CN">üá®üá≥ China</option>
                            <option value="TR">üáπüá∑ Turkey</option>
                            <option value="IN">üáÆüá≥ India</option>
                            <option value="RU">üá∑üá∫ Russia</option>
                            <option value="KZ">üá∞üáø Kazakhstan</option>
                            <option value="SG">üá∏üá¨ Singapore</option>
                            <option value="CZ">üá®üáø Czech Republic</option>
                            <option value="QA">üá∂üá¶ Qatar</option>
                            <option value="IQ">üáÆüá∂ Iraq</option>
                            <option value="HU">üá≠üá∫ Hungary</option>
                            <option value="AZ">üá¶üáø Azerbaijan</option>
                            <option value="BR">üáßüá∑ Brazil</option>
                        </optgroup>
                        <optgroup label="Major Holders (Stable)">
                            <option value="US">üá∫üá∏ United States</option>
                            <option value="DE">üá©üá™ Germany</option>
                            <option value="IT">üáÆüáπ Italy</option>
                            <option value="FR">üá´üá∑ France</option>
                            <option value="CH">üá®üá≠ Switzerland</option>
                            <option value="JP">üáØüáµ Japan</option>
                        </optgroup>
                    </select>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title" id="historicalChartTitle">Quarterly Central Bank Gold Activity</div>
                        <div class="chart-subtitle" id="historicalChartSubtitle">Source: World Gold Council</div>
                    </div>
                </div>
                <div class="chart-container" style="height: 450px;">
                    <canvas id="historicalChart"></canvas>
                </div>
            </div>

            <div class="table-container" style="margin-top: 24px;">
                <div class="table-header">
                    <div class="table-title" id="historicalTableTitle">Quarterly Data Table</div>
                    <button class="btn btn-secondary" onclick="exportHistorical()">‚Üì Export</button>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table id="historicalTable">
                        <thead>
                            <tr>
                                <th>Quarter</th>
                                <th>Net Purchases (t)</th>
                                <th>Total Holdings (t)</th>
                                <th>QoQ Change</th>
                                <th>Gold Price (Avg)</th>
                            </tr>
                        </thead>
                        <tbody id="historicalTableBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Countries Section -->
        <section class="content-section" id="countries">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Central Bank Holdings by Country</div>
                    <div class="search-box">
                        <span>üîç</span>
                        <input type="text" placeholder="Search country..." id="countrySearch" oninput="filterCountries()">
                    </div>
                </div>
                <div class="table-scroll-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Country</th>
                                <th>Holdings (t)</th>
                                <th>% Reserves</th>
                                <th>1Y Œî</th>
                                <th>2Y Œî</th>
                                <th>3Y Œî</th>
                                <th>4Y Œî</th>
                                <th>5Y Œî</th>
                            </tr>
                        </thead>
                        <tbody id="countriesTableBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Sources Section -->
        <section class="content-section" id="sources">
            <div class="sources-grid">
                <div class="source-card">
                    <div class="source-icon">üåê</div>
                    <div class="source-name">World Gold Council</div>
                    <div class="source-desc">Primary source for quarterly Gold Demand Trends reports. Published ~6-8 weeks after quarter end.</div>
                    <div class="source-meta">
                        <span>üìÖ Quarterly</span>
                        <span>üìä Best for trends</span>
                    </div>
                    <a href="https://www.gold.org/goldhub/research/gold-demand-trends" target="_blank" class="source-link">Visit Goldhub ‚Üí</a>
                </div>
                <div class="source-card">
                    <div class="source-icon">üèõÔ∏è</div>
                    <div class="source-name">IMF IFS Database</div>
                    <div class="source-desc">Official reserves data reported by member countries. Monthly updates, 1-2 month lag.</div>
                    <div class="source-meta">
                        <span>üìÖ Monthly</span>
                        <span>üìä Official data</span>
                    </div>
                    <a href="https://data.imf.org" target="_blank" class="source-link">Visit IMF ‚Üí</a>
                </div>
                <div class="source-card">
                    <div class="source-icon">üìä</div>
                    <div class="source-name">Trading Economics</div>
                    <div class="source-desc">Aggregated country-level data. Good for quick lookups and historical charts.</div>
                    <div class="source-meta">
                        <span>üìÖ Monthly</span>
                        <span>üìä Easy access</span>
                    </div>
                    <a href="https://tradingeconomics.com/country-list/gold-reserves" target="_blank" class="source-link">Visit ‚Üí</a>
                </div>
            </div>

            <div class="table-container" style="margin-top: 24px;">
                <div class="table-header">
                    <div class="table-title">Data Release Schedule</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Source</th>
                            <th>Frequency</th>
                            <th>Typical Lag</th>
                            <th>Next Expected</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>WGC Gold Demand Trends</td>
                            <td>Quarterly</td>
                            <td>6-8 weeks after Q end</td>
                            <td>~Feb 2026 (Q4 2025)</td>
                        </tr>
                        <tr>
                            <td>WGC Monthly Statistics</td>
                            <td>Monthly</td>
                            <td>4-6 weeks</td>
                            <td>Rolling</td>
                        </tr>
                        <tr>
                            <td>IMF IFS</td>
                            <td>Monthly</td>
                            <td>1-2 months</td>
                            <td>Rolling</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <div class="toast" id="toast">
        <span id="toastIcon">‚úì</span>
        <span id="toastMessage">Action completed</span>
    </div>

    <script>
        // ===========================================
        // QUARTERLY DATA - GLOBAL AGGREGATES
        // Source: World Gold Council Gold Demand Trends
        // ===========================================
        const quarterlyData = {
            netPurchases: {
                '2020-Q1': 109, '2020-Q2': 64, '2020-Q3': 12, '2020-Q4': 68,
                '2021-Q1': 95, '2021-Q2': 199, '2021-Q3': 91, '2021-Q4': 30,
                '2022-Q1': 84, '2022-Q2': 186, '2022-Q3': 459, '2022-Q4': 378,
                '2023-Q1': 228, '2023-Q2': 175, '2023-Q3': 337, '2023-Q4': 221,
                '2024-Q1': 290, '2024-Q2': 183, '2024-Q3': 186, '2024-Q4': 333,
                '2025-Q1': 244, '2025-Q2': 166, '2025-Q3': 220
            },
            holdings: {
                '2020-Q1': 34850, '2020-Q2': 34914, '2020-Q3': 34926, '2020-Q4': 34994,
                '2021-Q1': 35089, '2021-Q2': 35288, '2021-Q3': 35379, '2021-Q4': 35409,
                '2022-Q1': 35493, '2022-Q2': 35679, '2022-Q3': 36138, '2022-Q4': 36516,
                '2023-Q1': 36744, '2023-Q2': 36919, '2023-Q3': 37256, '2023-Q4': 37477,
                '2024-Q1': 37767, '2024-Q2': 37950, '2024-Q3': 38136, '2024-Q4': 38469,
                '2025-Q1': 38713, '2025-Q2': 38879, '2025-Q3': 39099
            },
            goldPrice: {
                '2020-Q1': 1583, '2020-Q2': 1711, '2020-Q3': 1909, '2020-Q4': 1874,
                '2021-Q1': 1794, '2021-Q2': 1816, '2021-Q3': 1790, '2021-Q4': 1795,
                '2022-Q1': 1877, '2022-Q2': 1871, '2022-Q3': 1729, '2022-Q4': 1726,
                '2023-Q1': 1890, '2023-Q2': 1976, '2023-Q3': 1928, '2023-Q4': 1971,
                '2024-Q1': 2070, '2024-Q2': 2338, '2024-Q3': 2474, '2024-Q4': 2663,
                '2025-Q1': 2860, '2025-Q2': 3100, '2025-Q3': 3457
            }
        };

        // ===========================================
        // QUARTERLY DATA BY COUNTRY
        // Holdings at quarter end (tonnes)
        // ===========================================
        const countryQuarterlyData = {
            'PL': {
                name: 'Poland',
                holdings: {
                    '2020-Q3': 229, '2021-Q3': 229, '2022-Q3': 229, '2023-Q3': 334, '2024-Q3': 420, '2025-Q3': 515
                }
            },
            'CN': {
                name: 'China',
                holdings: {
                    '2020-Q3': 1948, '2021-Q3': 1948, '2022-Q3': 1948, '2023-Q3': 2192, '2024-Q3': 2264, '2025-Q3': 2290
                }
            },
            'TR': {
                name: 'Turkey',
                holdings: {
                    '2020-Q3': 583, '2021-Q3': 423, '2022-Q3': 489, '2023-Q3': 523, '2024-Q3': 595, '2025-Q3': 635
                }
            },
            'IN': {
                name: 'India',
                holdings: {
                    '2020-Q3': 668, '2021-Q3': 734, '2022-Q3': 785, '2023-Q3': 804, '2024-Q3': 854, '2025-Q3': 886
                }
            },
            'RU': {
                name: 'Russia',
                holdings: {
                    '2020-Q3': 2299, '2021-Q3': 2302, '2022-Q3': 2299, '2023-Q3': 2333, '2024-Q3': 2336, '2025-Q3': 2340
                }
            },
            'KZ': {
                name: 'Kazakhstan',
                holdings: {
                    '2020-Q3': 391, '2021-Q3': 407, '2022-Q3': 360, '2023-Q3': 292, '2024-Q3': 283, '2025-Q3': 324
                }
            },
            'SG': {
                name: 'Singapore',
                holdings: {
                    '2020-Q3': 127, '2021-Q3': 154, '2022-Q3': 222, '2023-Q3': 230, '2024-Q3': 233, '2025-Q3': 236
                }
            },
            'CZ': {
                name: 'Czech Republic',
                holdings: {
                    '2020-Q3': 11, '2021-Q3': 11, '2022-Q3': 16, '2023-Q3': 30, '2024-Q3': 53, '2025-Q3': 67
                }
            },
            'QA': {
                name: 'Qatar',
                holdings: {
                    '2020-Q3': 56, '2021-Q3': 56, '2022-Q3': 66, '2023-Q3': 74, '2024-Q3': 87, '2025-Q3': 93
                }
            },
            'IQ': {
                name: 'Iraq',
                holdings: {
                    '2020-Q3': 96, '2021-Q3': 96, '2022-Q3': 130, '2023-Q3': 132, '2024-Q3': 152, '2025-Q3': 159
                }
            },
            'HU': {
                name: 'Hungary',
                holdings: {
                    '2020-Q3': 32, '2021-Q3': 94, '2022-Q3': 94, '2023-Q3': 94, '2024-Q3': 110, '2025-Q3': 110
                }
            },
            'AZ': {
                name: 'Azerbaijan',
                holdings: {
                    '2020-Q3': 72, '2021-Q3': 72, '2022-Q3': 72, '2023-Q3': 72, '2024-Q3': 97, '2025-Q3': 132
                }
            },
            'BR': {
                name: 'Brazil',
                holdings: {
                    '2020-Q3': 67, '2021-Q3': 130, '2022-Q3': 130, '2023-Q3': 130, '2024-Q3': 130, '2025-Q3': 161
                }
            },
            'US': {
                name: 'United States',
                holdings: {
                    '2020-Q3': 8134, '2021-Q3': 8134, '2022-Q3': 8134, '2023-Q3': 8134, '2024-Q3': 8134, '2025-Q3': 8134
                }
            },
            'DE': {
                name: 'Germany',
                holdings: {
                    '2020-Q3': 3362, '2021-Q3': 3359, '2022-Q3': 3355, '2023-Q3': 3353, '2024-Q3': 3352, '2025-Q3': 3352
                }
            },
            'IT': {
                name: 'Italy',
                holdings: {
                    '2020-Q3': 2452, '2021-Q3': 2452, '2022-Q3': 2452, '2023-Q3': 2452, '2024-Q3': 2452, '2025-Q3': 2452
                }
            },
            'FR': {
                name: 'France',
                holdings: {
                    '2020-Q3': 2436, '2021-Q3': 2436, '2022-Q3': 2437, '2023-Q3': 2437, '2024-Q3': 2437, '2025-Q3': 2437
                }
            },
            'CH': {
                name: 'Switzerland',
                holdings: {
                    '2020-Q3': 1040, '2021-Q3': 1040, '2022-Q3': 1040, '2023-Q3': 1040, '2024-Q3': 1040, '2025-Q3': 1040
                }
            },
            'JP': {
                name: 'Japan',
                holdings: {
                    '2020-Q3': 765, '2021-Q3': 846, '2022-Q3': 846, '2023-Q3': 846, '2024-Q3': 846, '2025-Q3': 846
                }
            },
            'NL': {
                name: 'Netherlands',
                holdings: {
                    '2020-Q3': 613, '2021-Q3': 613, '2022-Q3': 613, '2023-Q3': 613, '2024-Q3': 613, '2025-Q3': 613
                }
            },
            'TW': {
                name: 'Taiwan',
                holdings: {
                    '2020-Q3': 424, '2021-Q3': 424, '2022-Q3': 424, '2023-Q3': 424, '2024-Q3': 424, '2025-Q3': 424
                }
            },
            'UZ': {
                name: 'Uzbekistan',
                holdings: {
                    '2020-Q3': 326, '2021-Q3': 362, '2022-Q3': 395, '2023-Q3': 371, '2024-Q3': 368, '2025-Q3': 366
                }
            }
        };

        // Top holders for countries table - with historical data for % calculations
        // Current = Q3 2025, then Q3 for each prior year
        const topHolders = [
            { rank: 1, country: 'United States', code: 'US', holdings: 8133.5, pctReserves: 72.4, h: { y0: 8134, y1: 8134, y2: 8134, y3: 8134, y4: 8134, y5: 8134 } },
            { rank: 2, country: 'Germany', code: 'DE', holdings: 3352.3, pctReserves: 71.5, h: { y0: 3352, y1: 3352, y2: 3353, y3: 3355, y4: 3359, y5: 3362 } },
            { rank: 3, country: 'Italy', code: 'IT', holdings: 2451.8, pctReserves: 68.3, h: { y0: 2452, y1: 2452, y2: 2452, y3: 2452, y4: 2452, y5: 2452 } },
            { rank: 4, country: 'France', code: 'FR', holdings: 2436.9, pctReserves: 69.8, h: { y0: 2437, y1: 2437, y2: 2437, y3: 2437, y4: 2436, y5: 2436 } },
            { rank: 5, country: 'Russia', code: 'RU', holdings: 2340.0, pctReserves: 32.1, h: { y0: 2340, y1: 2336, y2: 2333, y3: 2299, y4: 2302, y5: 2299 } },
            { rank: 6, country: 'China', code: 'CN', holdings: 2290.0, pctReserves: 5.8, h: { y0: 2290, y1: 2264, y2: 2192, y3: 1948, y4: 1948, y5: 1948 } },
            { rank: 7, country: 'Switzerland', code: 'CH', holdings: 1040.0, pctReserves: 8.4, h: { y0: 1040, y1: 1040, y2: 1040, y3: 1040, y4: 1040, y5: 1040 } },
            { rank: 8, country: 'India', code: 'IN', holdings: 886.0, pctReserves: 10.8, h: { y0: 886, y1: 854, y2: 804, y3: 785, y4: 734, y5: 668 } },
            { rank: 9, country: 'Japan', code: 'JP', holdings: 846.0, pctReserves: 4.6, h: { y0: 846, y1: 846, y2: 846, y3: 846, y4: 846, y5: 765 } },
            { rank: 10, country: 'Turkey', code: 'TR', holdings: 635.0, pctReserves: 35.2, h: { y0: 635, y1: 595, y2: 523, y3: 489, y4: 423, y5: 583 } },
            { rank: 11, country: 'Netherlands', code: 'NL', holdings: 612.5, pctReserves: 62.4, h: { y0: 613, y1: 613, y2: 613, y3: 613, y4: 613, y5: 613 } },
            { rank: 12, country: 'Poland', code: 'PL', holdings: 515.0, pctReserves: 22.0, h: { y0: 515, y1: 420, y2: 334, y3: 229, y4: 229, y5: 229 } },
            { rank: 13, country: 'Taiwan', code: 'TW', holdings: 423.6, pctReserves: 4.4, h: { y0: 424, y1: 424, y2: 424, y3: 424, y4: 424, y5: 424 } },
            { rank: 14, country: 'Uzbekistan', code: 'UZ', holdings: 366.0, pctReserves: 82.0, h: { y0: 366, y1: 368, y2: 371, y3: 395, y4: 362, y5: 326 } },
            { rank: 15, country: 'Kazakhstan', code: 'KZ', holdings: 324.0, pctReserves: 56.2, h: { y0: 324, y1: 283, y2: 292, y3: 360, y4: 407, y5: 391 } },
            { rank: 16, country: 'Singapore', code: 'SG', holdings: 236.0, pctReserves: 4.2, h: { y0: 236, y1: 233, y2: 230, y3: 222, y4: 154, y5: 127 } },
            { rank: 17, country: 'Brazil', code: 'BR', holdings: 161.0, pctReserves: 3.1, h: { y0: 161, y1: 130, y2: 130, y3: 130, y4: 130, y5: 67 } },
            { rank: 18, country: 'Iraq', code: 'IQ', holdings: 159.0, pctReserves: 10.2, h: { y0: 159, y1: 152, y2: 132, y3: 130, y4: 96, y5: 96 } },
            { rank: 19, country: 'Azerbaijan', code: 'AZ', holdings: 132.0, pctReserves: 18.0, h: { y0: 132, y1: 97, y2: 72, y3: 72, y4: 72, y5: 72 } },
            { rank: 20, country: 'Hungary', code: 'HU', holdings: 110.0, pctReserves: 12.5, h: { y0: 110, y1: 110, y2: 94, y3: 94, y4: 94, y5: 32 } },
            { rank: 21, country: 'Qatar', code: 'QA', holdings: 93.0, pctReserves: 7.8, h: { y0: 93, y1: 87, y2: 74, y3: 66, y4: 56, y5: 56 } },
            { rank: 22, country: 'Czech Republic', code: 'CZ', holdings: 67.0, pctReserves: 5.2, h: { y0: 67, y1: 53, y2: 30, y3: 16, y4: 11, y5: 11 } }
        ];

        // Top Q3 2025 buyers
        const topQ3Buyers = [
            { country: 'Brazil', purchases: 31 },
            { country: 'Kazakhstan', purchases: 18 },
            { country: 'Czech Republic', purchases: 4 },
            { country: 'China', purchases: 5 },
            { country: 'Turkey', purchases: 5 },
            { country: 'Russia', purchases: 4 },
            { country: 'India', purchases: 3 }
        ];

        // Chart instances
        let quarterlyChart, topBuyersChartInstance, cumulativeChartInstance, historicalChartInstance;

        // ===========================================
        // INITIALIZATION
        // ===========================================
        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            initializeCharts();
            populateCountriesTable();
            populateHistoricalTable();
            updateLastUpdated();
        });

        function initializeTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });

            document.querySelectorAll('.time-filter').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.time-filter').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    updateQuarterlyChart(parseInt(this.dataset.quarters));
                });
            });
        }

        function initializeCharts() {
            Chart.defaults.color = '#A0A0A0';
            Chart.defaults.borderColor = '#2A2A2A';
            Chart.defaults.font.family = "'DM Sans', sans-serif";

            createQuarterlyPurchasesChart();
            createTopBuyersChart();
            createCumulativeChart();
            createHistoricalChart();
        }

        // ===========================================
        // CHARTS
        // ===========================================
        function createQuarterlyPurchasesChart() {
            const ctx = document.getElementById('quarterlyPurchasesChart').getContext('2d');
            const quarters = Object.keys(quarterlyData.netPurchases).slice(-12);
            const data = quarters.map(q => quarterlyData.netPurchases[q]);

            quarterlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: quarters,
                    datasets: [{
                        label: 'Net Purchases (tonnes)',
                        data: data,
                        backgroundColor: data.map(v => v >= 0 ? 'rgba(212, 175, 55, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                        borderColor: data.map(v => v >= 0 ? '#D4AF37' : '#EF4444'),
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1A1A1A',
                            borderColor: '#2A2A2A',
                            borderWidth: 1,
                            callbacks: {
                                label: (ctx) => `${ctx.parsed.y >= 0 ? '+' : ''}${ctx.parsed.y.toLocaleString()}t`
                            }
                        }
                    },
                    scales: {
                        y: { grid: { color: '#2A2A2A' }, ticks: { callback: (v) => `${v}t` } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateQuarterlyChart(numQuarters) {
            const quarters = Object.keys(quarterlyData.netPurchases).slice(-numQuarters);
            const data = quarters.map(q => quarterlyData.netPurchases[q]);

            quarterlyChart.data.labels = quarters;
            quarterlyChart.data.datasets[0].data = data;
            quarterlyChart.data.datasets[0].backgroundColor = data.map(v => v >= 0 ? 'rgba(212, 175, 55, 0.8)' : 'rgba(239, 68, 68, 0.8)');
            quarterlyChart.data.datasets[0].borderColor = data.map(v => v >= 0 ? '#D4AF37' : '#EF4444');
            quarterlyChart.update();
        }

        function createTopBuyersChart() {
            const ctx = document.getElementById('topBuyersChart').getContext('2d');
            
            topBuyersChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topQ3Buyers.map(b => b.country),
                    datasets: [{
                        data: topQ3Buyers.map(b => b.purchases),
                        backgroundColor: 'rgba(212, 175, 55, 0.8)',
                        borderColor: '#D4AF37',
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: (ctx) => `+${ctx.parsed.x}t` } }
                    },
                    scales: {
                        x: { grid: { color: '#2A2A2A' }, ticks: { callback: (v) => `+${v}t` } },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        function createCumulativeChart() {
            const ctx = document.getElementById('cumulativeChart').getContext('2d');
            const quarters = Object.keys(quarterlyData.holdings);
            const data = quarters.map(q => quarterlyData.holdings[q]);

            cumulativeChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: quarters,
                    datasets: [{
                        data: data,
                        borderColor: '#D4AF37',
                        backgroundColor: 'rgba(212, 175, 55, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 2,
                        pointHoverRadius: 6,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#2A2A2A' }, ticks: { callback: (v) => `${(v/1000).toFixed(1)}k` } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function createHistoricalChart() {
            const ctx = document.getElementById('historicalChart').getContext('2d');
            const quarters = Object.keys(quarterlyData.netPurchases).slice(-12);
            const data = quarters.map(q => quarterlyData.netPurchases[q]);

            historicalChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: quarters,
                    datasets: [{
                        data: data,
                        backgroundColor: data.map(v => v >= 0 ? 'rgba(212, 175, 55, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                        borderColor: data.map(v => v >= 0 ? '#D4AF37' : '#EF4444'),
                        borderWidth: 1,
                        borderRadius: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#2A2A2A' }, ticks: { callback: (v) => `${v}t` } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateHistoricalChart() {
            const period = parseInt(document.getElementById('historicalPeriod').value);
            const view = document.getElementById('historicalView').value;
            const country = document.getElementById('countryFilter').value;
            
            let quarters, data, title, subtitle;
            
            if (country === 'all') {
                const allQuarters = Object.keys(view === 'quarterly' ? quarterlyData.netPurchases : quarterlyData.holdings);
                quarters = allQuarters.slice(-period);
                data = quarters.map(q => view === 'quarterly' ? quarterlyData.netPurchases[q] : quarterlyData.holdings[q]);
                title = view === 'quarterly' ? 'Global Quarterly Net Purchases' : 'Global Cumulative Holdings';
                subtitle = 'All central banks combined';
            } else {
                const countryInfo = countryQuarterlyData[country];
                if (!countryInfo) { showToast('Country data not available', 'error'); return; }
                
                const allQuarters = Object.keys(countryInfo.holdings).sort();
                quarters = allQuarters.slice(-Math.min(period, allQuarters.length));
                
                if (view === 'quarterly') {
                    data = quarters.map((q, i) => {
                        const current = countryInfo.holdings[q];
                        const prev = i > 0 ? countryInfo.holdings[quarters[i-1]] : current;
                        return current - prev;
                    });
                    title = `${countryInfo.name} - Quarterly Net Purchases`;
                } else {
                    data = quarters.map(q => countryInfo.holdings[q]);
                    title = `${countryInfo.name} - Holdings`;
                }
                subtitle = 'Source: IMF IFS, World Gold Council';
            }
            
            document.getElementById('historicalChartTitle').textContent = title;
            document.getElementById('historicalChartSubtitle').textContent = subtitle;
            
            if (view === 'quarterly') {
                historicalChartInstance.config.type = 'bar';
                historicalChartInstance.data.datasets[0].backgroundColor = data.map(v => v >= 0 ? 'rgba(212, 175, 55, 0.8)' : 'rgba(239, 68, 68, 0.8)');
                historicalChartInstance.data.datasets[0].borderColor = data.map(v => v >= 0 ? '#D4AF37' : '#EF4444');
                historicalChartInstance.data.datasets[0].fill = false;
            } else {
                historicalChartInstance.config.type = 'line';
                historicalChartInstance.data.datasets[0].backgroundColor = 'rgba(212, 175, 55, 0.1)';
                historicalChartInstance.data.datasets[0].borderColor = '#D4AF37';
                historicalChartInstance.data.datasets[0].fill = true;
                historicalChartInstance.data.datasets[0].tension = 0.4;
            }
            
            historicalChartInstance.data.labels = quarters;
            historicalChartInstance.data.datasets[0].data = data;
            historicalChartInstance.update();
            
            populateHistoricalTable(period, country, view);
        }

        // ===========================================
        // TABLES
        // ===========================================
        
        // Calculate % change between two values
        function calcPctChange(current, previous) {
            if (!previous || previous === 0) return null;
            return ((current - previous) / previous * 100).toFixed(1);
        }

        // Format % change for display
        function formatPctChange(pct) {
            if (pct === null || pct === undefined || isNaN(pct)) return '‚Äî';
            const num = parseFloat(pct);
            const sign = num >= 0 ? '+' : '';
            const cssClass = num > 0 ? 'change-positive' : num < 0 ? 'change-negative' : '';
            return `<span class="pct-change ${cssClass}">${sign}${num}%</span>`;
        }

        function populateCountriesTable() {
            const tbody = document.getElementById('countriesTableBody');
            tbody.innerHTML = topHolders.map(h => {
                // Calculate % changes: y0=current, y1=1yr ago, y2=2yr ago, etc.
                const pct1y = calcPctChange(h.h.y0, h.h.y1);
                const pct2y = calcPctChange(h.h.y0, h.h.y2);
                const pct3y = calcPctChange(h.h.y0, h.h.y3);
                const pct4y = calcPctChange(h.h.y0, h.h.y4);
                const pct5y = calcPctChange(h.h.y0, h.h.y5);
                
                return `
                <tr>
                    <td>${h.rank}</td>
                    <td><div class="country-cell"><div class="country-flag">${h.code}</div><span>${h.country}</span></div></td>
                    <td class="tonnes">${h.holdings.toLocaleString()}</td>
                    <td>${h.pctReserves}%</td>
                    <td>${formatPctChange(pct1y)}</td>
                    <td>${formatPctChange(pct2y)}</td>
                    <td>${formatPctChange(pct3y)}</td>
                    <td>${formatPctChange(pct4y)}</td>
                    <td>${formatPctChange(pct5y)}</td>
                </tr>
            `}).join('');
        }

        function filterCountries() {
            const search = document.getElementById('countrySearch').value.toLowerCase();
            const filtered = topHolders.filter(h => h.country.toLowerCase().includes(search) || h.code.toLowerCase().includes(search));
            
            const tbody = document.getElementById('countriesTableBody');
            tbody.innerHTML = filtered.map(h => {
                const pct1y = calcPctChange(h.h.y0, h.h.y1);
                const pct2y = calcPctChange(h.h.y0, h.h.y2);
                const pct3y = calcPctChange(h.h.y0, h.h.y3);
                const pct4y = calcPctChange(h.h.y0, h.h.y4);
                const pct5y = calcPctChange(h.h.y0, h.h.y5);
                
                return `
                <tr>
                    <td>${h.rank}</td>
                    <td><div class="country-cell"><div class="country-flag">${h.code}</div><span>${h.country}</span></div></td>
                    <td class="tonnes">${h.holdings.toLocaleString()}</td>
                    <td>${h.pctReserves}%</td>
                    <td>${formatPctChange(pct1y)}</td>
                    <td>${formatPctChange(pct2y)}</td>
                    <td>${formatPctChange(pct3y)}</td>
                    <td>${formatPctChange(pct4y)}</td>
                    <td>${formatPctChange(pct5y)}</td>
                </tr>
            `}).join('');
        }

        function populateHistoricalTable(period = 12, country = 'all', view = 'quarterly') {
            const tbody = document.getElementById('historicalTableBody');
            
            if (country === 'all') {
                const quarters = Object.keys(quarterlyData.netPurchases).reverse().slice(0, period);
                tbody.innerHTML = quarters.map(q => {
                    const purchases = quarterlyData.netPurchases[q];
                    const holdings = quarterlyData.holdings[q];
                    const prevQ = getPreviousQuarter(q);
                    const prevHoldings = quarterlyData.holdings[prevQ] || holdings;
                    const qoqChange = ((holdings - prevHoldings) / prevHoldings * 100).toFixed(1);
                    const price = quarterlyData.goldPrice[q];
                    return `<tr>
                        <td>${q}</td>
                        <td class="${purchases >= 0 ? 'change-positive' : 'change-negative'}">${purchases >= 0 ? '+' : ''}${purchases}</td>
                        <td class="tonnes">${holdings.toLocaleString()}</td>
                        <td class="${qoqChange >= 0 ? 'change-positive' : 'change-negative'}">${qoqChange >= 0 ? '+' : ''}${qoqChange}%</td>
                        <td>$${price.toLocaleString()}</td>
                    </tr>`;
                }).join('');
            } else {
                const countryInfo = countryQuarterlyData[country];
                if (!countryInfo) return;
                
                const quarters = Object.keys(countryInfo.holdings).reverse().slice(0, period);
                tbody.innerHTML = quarters.map((q, i) => {
                    const holdings = countryInfo.holdings[q];
                    const prevQ = getPreviousQuarter(q);
                    const prevHoldings = countryInfo.holdings[prevQ] || holdings;
                    const change = holdings - prevHoldings;
                    const qoqChange = prevHoldings > 0 ? ((holdings - prevHoldings) / prevHoldings * 100).toFixed(1) : '‚Äî';
                    const price = quarterlyData.goldPrice[q] || '‚Äî';
                    return `<tr>
                        <td>${q}</td>
                        <td class="${change >= 0 ? 'change-positive' : 'change-negative'}">${change >= 0 ? '+' : ''}${change}</td>
                        <td class="tonnes">${holdings.toLocaleString()}</td>
                        <td class="${parseFloat(qoqChange) >= 0 ? 'change-positive' : 'change-negative'}">${qoqChange !== '‚Äî' ? (parseFloat(qoqChange) >= 0 ? '+' : '') + qoqChange + '%' : qoqChange}</td>
                        <td>${typeof price === 'number' ? '$' + price.toLocaleString() : price}</td>
                    </tr>`;
                }).join('');
            }
        }

        function getPreviousQuarter(q) {
            const [year, quarter] = q.split('-Q');
            const qNum = parseInt(quarter);
            if (qNum === 1) return `${parseInt(year) - 1}-Q4`;
            return `${year}-Q${qNum - 1}`;
        }

        // ===========================================
        // UTILITIES
        // ===========================================
        function updateLastUpdated() {
            document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function refreshData() {
            showToast('Refreshing data...', 'success');
            setTimeout(() => { updateLastUpdated(); showToast('Data refreshed!', 'success'); }, 1000);
        }

        function exportData() {
            let csv = 'Rank,Country,Holdings (t),% of Reserves,1Y %,2Y %,3Y %,4Y %,5Y %\n';
            topHolders.forEach(h => {
                const pct1y = calcPctChange(h.h.y0, h.h.y1) || 0;
                const pct2y = calcPctChange(h.h.y0, h.h.y2) || 0;
                const pct3y = calcPctChange(h.h.y0, h.h.y3) || 0;
                const pct4y = calcPctChange(h.h.y0, h.h.y4) || 0;
                const pct5y = calcPctChange(h.h.y0, h.h.y5) || 0;
                csv += `${h.rank},${h.country},${h.holdings},${h.pctReserves},${pct1y},${pct2y},${pct3y},${pct4y},${pct5y}\n`;
            });
            downloadFile(csv, 'central_bank_gold_holdings.csv', 'text/csv');
            showToast('Data exported!', 'success');
        }

        function exportHistorical() {
            const country = document.getElementById('countryFilter').value;
            let csv, filename;
            
            if (country === 'all') {
                csv = 'Quarter,Net Purchases (t),Holdings (t),Gold Price (USD)\n';
                Object.keys(quarterlyData.netPurchases).forEach(q => {
                    csv += `${q},${quarterlyData.netPurchases[q]},${quarterlyData.holdings[q]},${quarterlyData.goldPrice[q]}\n`;
                });
                filename = 'cb_gold_quarterly_global.csv';
            } else {
                const info = countryQuarterlyData[country];
                csv = 'Quarter,Holdings (t),Quarterly Change (t)\n';
                const quarters = Object.keys(info.holdings);
                quarters.forEach((q, i) => {
                    const prev = i > 0 ? info.holdings[quarters[i-1]] : info.holdings[q];
                    csv += `${q},${info.holdings[q]},${info.holdings[q] - prev}\n`;
                });
                filename = `cb_gold_quarterly_${info.name.toLowerCase().replace(/\s+/g, '_')}.csv`;
            }
            
            downloadFile(csv, filename, 'text/csv');
            showToast('Historical data exported!', 'success');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.className = `toast ${type}`;
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
